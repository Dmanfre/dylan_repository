---
title: "bls_work"
author: "Dylan Manfre"
date: "2023-09-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Establishing my steps


 What are my steps here and can I create a loop from it?
 Import the dataset wbb_rosters_22_23
 establish the power_five list power_five <- c("SEC", "Big Ten", "Pac-12", "Big 12", "ACC")

Try to set this up so that the code is underneith a sentence that I would write in the story. 


*** Genearl notes *****

Thinking of making this story more of a listical piece where I provide a graphic that answers questions I have when writing the code and analyzing the data. Each section of the story would be an answered question about the women's basketball data. And all of them will be relating back to Maryland or Power 5 at large.

General questions
- Do I start national and work down to a more local level?
- Do I include schools that are moving into the Big Ten in the latest 23-24 data?
- How do I work in the census data to get per capita numbers (look back at the textbook and previous labs)

Steps
- Generate the numbers per capita for the state and then the local towns
- Get state populations by using Census API 
- Begin writing the questions for the story
- Start national and then work down

Story questions to be analyzed by the data (In no particular order)
- Where to women's basketball players in Maryland come from
- Where do Big 10 players come from in Maryland?
- Which county or state produces the most women's basketball players?
- How many Power 5 players are there in Maryland?
- Which state has the most WBB players per capita?
- How many DI, II and III players are there. 

Story Structure (Start wide and work your way in)
- National numbers
- Maryland state numbers
- Basketball centric numbers: ie: Big 10, Division I etc.

```{r}
#libraries
library(tidyverse)
library(tidycensus)
library(janitor)
library(lubridate)
#install.packages("ipumsr")
library(ipumsr)

```

```{r}

#Loading in the data from 22-23 season

wbb_rosters_22_23 <- read_csv("data/wbb_rosters_2022_23.csv")
head(wbb_rosters_22_23)

#Loading in 23-24 data when I have it


```

*** Organized section ****


Working Lede: With women's basketball season approaching, let's see where players come form within the US and abroad. While Maryland lost a plethora of talent, including three of its starters, the Terps have a good crop of experience and newcomers to work with.


Question: What state has the most WBB players
Answer: PA has the most with 915
Sentence: There are over 1,000 players who hail from overseas (say some of the best international names), but Pennsylvania, New York and Texas dominate the domestic states with 915, 900 and 992 players respectively.

```{r}
state_counts <- wbb_rosters_22_23 %>% 
group_by(state_clean) %>%
count() %>% 
arrange(desc(n)) %>% 
rename(players = n) %>% 
rename(state_abbrev = state_clean)
#1073 NAs
```

Division I state counts
```{r}

d1_state_counts <- wbb_rosters_22_23 %>% 
filter(division == "I") %>% 
group_by(state_clean) %>% 
count() %>% 
rename(number_of_players = n) %>% 
arrange(desc(number_of_players))

```

Sentence: 1073 players representing 87 countries are playing division I women's basketball.
```{r}
international_players <- wbb_rosters_22_23 %>% 
filter(country_clean != "USA")

countries <- international_players %>% 
group_by(country_clean) %>% 
count() %>% 
arrange(desc(n))
view(countries)
```



Question: Where are D-I players from in Maryland
Sentece: Maryland has 133 Division I women's basketball players and they come from all over the state. 18% of them are at power 5 institutions. 

Notes
#Note: Putting here Percentage of D I players at Power 5 schools.
#There are 24 P5 players at Division I schools
#18% of division I players from Maryland attend P5 schools.

```{r}

division_one_md <- wbb_rosters_22_23 %>% 
filter(state_clean == "MD", division == "I")
md_d1_p5_perc = (24/133)*100

division_one_usa <- wbb_rosters_22_23 %>% 
filter(division == "I")

```


Question: How many WBB players are from Maryland? How many of those players attend power 5 schools.?
Answer: 350 are from Maryland and 24 of them attend Power 5 schools
Sentence: Roughly 7% of all Maryland wbb players attend power five schools.
```{r}
power_five <- c("SEC", "Big Ten", "Pac-12", "Big 12", "ACC")

wbb_rosters_22_23 %>%
filter (state_clean == "MD")
#produces 350 names

from_maryland_p5 <-  wbb_rosters_22_23 %>% 
filter(conference %in% power_five, state_clean == "MD")
#Produces 24 names
```

Notes
- Should I try to compare this to other staes?
```{r}

#Percentage of MD players at P5 institutions
md_p5_perc <-  (24 / 350)*100
  
```


Question: Which power 5 conference produces the most WBB players?
Answer: There are 875 power 5 wbb players and 196 of them are from the ACC, the mos of the fiv econferneces.
Sentence: It's pretty hard to land a scholarship offer. (Insert stat about college athletes)/ Getting a spot in one of the five conferences (soon to be 4?) is even harder. Only 875 women's basektball players attend Power 5 institutions. The ACC is most likely to take you. They have 196 players, but not much in front of the Big Ten with 194.

```{r}
wbb_rosters_22_23 %>%
filter(conference == power_five)

#What I want to do here is make a value that says power_five and have that be equal to "Big Ten", "Big 12", "ACC", "SEC', "Pac-12" so that when I filter I can say Filter to show me only players in the power_five conferences.
```

# Issue: These numbers seem too low. Im trying to view how many players there are in the power 5 conferneces
# Why doesn't every roster show up?

```{r}
#Second attempt
# ChatGPT says to use in%in instead of %> %>% 

total_p5_players <- wbb_rosters_22_23 %>%
filter(conference %in% power_five)
#This produces 875 results which is much cleaner and seems to be more accurate. 

#Conference counts with percentages
d1_conf_counts <- wbb_rosters_22_23 %>% 
filter(division == "I", state_clean == "MD") %>% 
group_by(conference) %>%
summarize(total_players = n()) %>% 
arrange(desc(total_players)) %>% 
mutate(perc = round(total_players/sum(total_players)*100,1))

onlybigten <- from_maryland_p5 %>% 
filter(conference == "Big Ten")



```


Question: How many players from Maryland does each power 5 confernece have?
Answer: ACC and Big Ten each have 8 and there are no players from the Big 12
Sentence: The lone Pac-12 player from Maryland will soon jump to the Big Ten as UCLA is set to join in Aug. 2024

Note: Decide what to do with conference realignment teams here.
```{r}
conference_md <- from_maryland_p5 %>% 
group_by(conference) %>% 
count() %>% 
rename(players_from_md = n)

#Remember to factor in conference realignment...

```

Question: Where do the Power 5 Players come from in Maryland specifically?
Answer: Baltimore has the most with 6 players on P5 tems. It also has the most players of any division.
Sentence:

Note: Decide which is more focused for the story
```{r}
# Division One players from Maryland
md_d1_hometown <- division_one_md %>% 
group_by(hometown_clean) %>% 
count() %>% 
arrange(desc(n)) %>% 
rename(players_from_md = n)

#All Players from Maryland
all_md_players_hometown <-  wbb_rosters_22_23 %>% 
filter(state_clean == "MD") %>% 
group_by(hometown_clean) %>% 
count() %>% 
arrange(desc(n)) %>% 
rename(players_from_md = n)
view(all_md_players_hometown)

#d1 players from Maryland
division_one_md %>% 
group_by(hometown_clean) %>% 
count() %>% 
arrange(desc(n)) %>% 
rename(players_from_md = n)


#exporting these to csv

write_csv(md_p5_hometown, "data/md_p5_hometown.csv")

write_csv(md_2021, "data/md_2021.csv")


```

Question: What teams do the Power 5 players from Maryland play for?
Answer: UMD has 3 players from Maryland. Surprised to see Arkansas have 2 players 
Sentence: Power five players from Maryland represent 17 teams. Maryland has the most with three players (name them). Other schools that have Maryland-orginated players are actually not that close to the state at all. University of Arkansas, Boston College and University of Kentucky each have two players.  

```{r}
from_maryland_p5 %>% 
group_by(team) %>% 
count() %>% 
arrange(desc(n))

```

*** Beginning to work on the section with Census Data ***

```{r}
#API key
Sys.setenv(CENSUS_API_KEY = "5cb2b9c628a1d1329c5bf4d36fe4435c6501efc8", overwrite = TRUE)

#2021 ACS
ACS_2021 <- load_variables(2021, "acs5")

#2022 ACS
ACS_2022 <- load_variables(2022, "acs1")

#GEOID will be key to matching the places up together. 

usa_2022 <- get_acs(geography = "state",
                variables = c(population = "B01003_001"),
                survey = "acs1",
                year = 2022) %>% 
  mutate(year = 2022) %>% 
  rename(state = NAME)
```
Notes
I think I need to join the populations to the state_counts dataframe to then do a mutate and identify number of WBB players per capita in each state.  
Would I need to change the city names to be accurate with the census stuff

Per Derek: "Using 2022 1-year values will only get you the largest places in the state. Probably need to dial it back to an earlier year"

Get census data with abbreviations for states. and then join it to the states_clean column within the WBB players data to show the per capita numbers for each state. and say there are x players per capita in each state. Multiply that by 100,000

Next Steps
- Import data(fips_codes) ... DONE (This gives abbreviated state column)
- join fips_code to usa_2022 to get the abbreviated states. 
- Then join that to the state_counts so that the state_counts has the population of each state.

```{r}
#Maybe do per capita numbers on state_counts to say how this is how many players there are in Maryland per capita? Or do the 

data(fips_codes)

#first attempt
joined_states <- inner_join(usa_2022, fips_codes, by = "state")

#second attempt
joined_states <- usa_2022 %>%
  left_join(fips_codes, by = c("state"))

#third attempt
usa_2022 %>% 
mutate(state_name = state.abb)

#fourth attempt (from chatGPT)
state_abbreviations <- data.frame(
  statenames = state.name,
  state_abbrev = state.abb)

usa_2022 <- usa_2022 %>%
  left_join(state_abbreviations, by = c("state" = "statenames"))\
  
  usa_2022 <- usa_2022 %>%
  select(-state_abbrev.y)
```

Here is where I populate with DC and PR I am writing code so that DC and PR appear where the datgaframe says District of Columbia and Puerto Rico

```{r}
usa_2022 <- usa_2022 %>% 
mutate(state_abbrev = case_when(
    state == "District of Columbia" ~ "DC",
    state == "Puerto Rico" ~ "PR",
    TRUE ~ state_abbrev
  ))

```


joining state_counts of wbb players to usa_2022
Or should I go the other way around?

```{r}
#joining with state_counts

usa_2022_with_state_counts <- usa_2022 %>% 
  left_join(state_counts, usa_2022, by = "state_abbrev")
```


Sentence: There are X women's basketball players per capita in each state.
Need to figure out how to get DC to show up from the census data or do a case when to populate it with DC and PR
```{r}
#generating per capita 

usa_2022_with_state_counts <- usa_2022_with_state_counts %>% 
  mutate(per_capita = (players/estimate)*100000) %>% 
  arrange(desc(per_capita))

```

Now filtering this WBB dataset for JUST division I players per capita

```{r}
#filtering for D1
division_one_usa <- wbb_rosters_22_23 %>% 
filter(division == "I")

#getting d1_state_counts
division_one_usa <- division_one_usa %>% 
group_by(state_clean) %>%
count() %>% 
arrange(desc(n)) %>% 
rename(players = n) %>% 
rename(state_abbrev = state_clean)

#joining
D1_usa_2022_with_state_counts <- usa_2022 %>% 
  left_join(division_one_usa, usa_2022, by = "state_abbrev")

#gebnerating per capita numbers for D1 players
D1_usa_2022_with_state_counts <- D1_usa_2022_with_state_counts %>% 
  mutate(per_capita = (players/estimate)*100000) %>% 
  arrange(desc(per_capita))

```



Section with 2023-2024 datat

```{r}

wbb_rosters_23_24 <- read_csv("data/wbb_rosters_2023_24.csv")
)

```

Cleaning the datat

```{r}

wbb_rosters_23_24 <- wbb_rosters_23_24 %>%
  mutate(copy = hometown) %>% 
  separate(hometown, into = c("town", "state"), sep = ", ")

view(wbb_rosters_23_24)
#seperate that into two columns based on the comma using seperate and then find a package to abbreviate the states
```




```{r}
#Find a package that abbrevaites the state column

wbb_rosters_23_24 <-  wbb_rosters_23_24 %>% 


view(wbb_rosters_23_24)

```






```{r}
